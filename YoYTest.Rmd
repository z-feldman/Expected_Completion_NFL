---
title: "TestModelsByQB"
author: "Zach Feldman"
date: "3/4/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(broom)
library(tidyverse)
```

Test XGBoost, GAM, Air Yards only GAM
```{r}
plays_qb_test <- cpoe_passes %>% select(season, passer_player_name, complete_pass)
```

Add prediction columns
```{r}
plays_qb_test$xgboost_pred <- xgb_mod_full_pred
plays_qb_test$gam_pred <- gam_pred_full
plays_qb_test$gam_air_pred <- gam_pred_air_full
```

Add cpoe columns
```{r}
plays_qb_test %<>% mutate(cpoe_xgb = complete_pass - xgboost_pred,
                          cpoe_gam = complete_pass - gam_pred,
                          cpoe_air = complete_pass - gam_air_pred)

```

Group by season and qb
```{r}
cpoe_by_season <- plays_qb_test %>% group_by(passer_player_name, season) %>% 
  summarise(attempts = n(),
            cpoe_sum_xgb_season = sum(cpoe_xgb),
            cpoe_sum_gam_season = sum(cpoe_gam),
            cpoe_sum_air_season = sum(cpoe_air),
            
            cpoe_mean_xgb_season = mean(cpoe_xgb),
            cpoe_mean_gam_season = mean(cpoe_gam),
            cpoe_mean_air_season = mean(cpoe_air))
```

Test year over year with map
```{r}
yoy_model <- function(cpoe, df) {
  lm(data = df, formula = cpoe ~ lag(cpoe), na.action = na.omit) %>% glance() %>%
    select(r.squared) %>% as.numeric()
}

min_attempts <- 320

cpoe_by_season %>% 
  filter(attempts >= min_attempts) %>% 
  group_by(passer_player_name, season) %>% 
  arrange(passer_player_name, season) %>% 
  map_at(vars(contains("cpoe")), .f = yoy_model)

cpoe_by_season %>% filter(attempts >= min_attempts) %>% 
  group_by(passer_player_name, season) %>% 
  arrange(passer_player_name, season) %>%
  map_at(vars(contains("cpoe")), .f = ~cor(., lag(.), use = "na.or.complete"))
```


Test against 2019 data
```{r}
test_19 <- cpoe_19_passes %>% select(complete_pass, air_yards, yardline_100, ydstogo, receiver_position, 
         down, qtr, wp, ep, air_is_zero, pass_is_middle, under_two_min, early_downs, 
         tipped, hail_mary, roof, posteam_type, week, season)

test_19 %<>% modify_if(is_character, as_factor)

test_19_dmatrix <- xgb.DMatrix(model.matrix(~., data = test_19 %>% select(-complete_pass)), label = test_19$complete_pass)
dimnames(test_19_dmatrix) <- dimnames(full_train)
test_19$xgb <- predict(xgb_mod_full, test_19_dmatrix)
test_19$gam <- predict.bam(gam_full, test_19 %>% select(-xgb), type = "response")
test_19$air <- predict.bam(gam_air_full, test_19 %>% select(-xgb, -gam), type = "response")

test_19 %<>% mutate(xgb_error = complete_pass - xgb,
                    gam_error = complete_pass - gam,
                    air_error = complete_pass - air)

test_19 %>% summarise(xgb_rmse = round(sqrt(mean(xgb_error^2)), 3),
                      gam_rmse = round(sqrt(mean(gam_error^2)), 3),
                      air_rmse = round(sqrt(mean(air_error^2)), 3))
```










