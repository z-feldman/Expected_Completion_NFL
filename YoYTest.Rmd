---
title: "TestModelsByQB"
author: "Zach Feldman"
date: "3/4/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Test 4_gauss, 5, Ben, Josh, air rn, already having run predictions in CPOE.R
```{r}
plays_qb_test <- cpoe_passes %>% select(season, passer_player_name, complete_pass)
```

Add prediction columns
```{r}
plays_qb_test$air_pred <- plogis(pred_air$fit)
plays_qb_test$model4_pred <- plogis(pred4$fit)
plays_qb_test$xgb_pred <- xgb_mod_full_pred

```

Add cpoe columns
```{r}
plays_qb_test %<>% mutate(cpoe_air = complete_pass - air_pred,
                          cpoe_model4 = complete_pass - model4_pred,
                          cpoe_xgb = complete_pass - xgb_pred)
```

Group by season and qb
```{r}
cpoe_by_season <- plays_qb_test %>% group_by(passer_player_name, season) %>% 
  summarise(attempts = n(),
            cpoe_sum_air_season = sum(cpoe_air),
            cpoe_sum_model4_season = sum(cpoe_model4),
            cpoe_sum_xgb_season = sum(cpoe_xgb),
            
            cpoe_mean_air_season = mean(cpoe_air),
            cpoe_mean_model4_season = mean(cpoe_model4),
            cpoe_mean_xgb_season = mean(cpoe_xgb))
```

Test year over year
```{r}
cpoe_by_season %>% 
  filter(attempts >= 320) %>% 
  group_by(passer_player_name, season) %>% arrange(passer_player_name, season) %>%
  lm(formula = cpoe_sum_model6_gauss_season ~ lag(cpoe_sum_model6_gauss_season) + season, na.action = na.omit) %>% glance() %>% select(adj.r.squared) %>% as.numeric()
```


```{r}
cpoe_by_season[10,] %>% map_at(vars(contains("cpoe")), as.character)

cpoe_by_season %>% select(contains("cpoe")) %>% colnames()


yoy_model <- function(cpoe, season, df) {
  lm(data = df, formula = cpoe ~ lag(cpoe), na.action = na.omit) %>% glance() %>%
    select(r.squared) %>% as.numeric()
}
cpoe_by_season %>% 
  filter(attempts >= 320) %>% 
  group_by(passer_player_name, season) %>% 
  arrange(passer_player_name, season) %>% 
  map_at(vars(contains("cpoe")), .f = yoy_model)


cpoe_yay -> cpoe_by_season %>% 
  filter(attempts >= 320) %>% 
  group_by(passer_player_name, season) %>% 
  arrange(passer_player_name, season) 


cpoe_yay %>% 
  map_at(vars(contains("cpoe")), ~(lm(. ~ lag(.) + cpoe_yay$season, na.action = na.omit) %>% glance() %>% select(adj.r.squared) %>% as.numeric()))

```













